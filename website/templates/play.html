<!--
  Copyright 2021 Google LLC

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

{% extends "base.html" %}

{% block title %}Play Quiz{% endblock %}

{% block content %}


{% if quiz == None %}
    <div class="mdc-layout-grid">
        <div class="mdc-layout-grid__inner">
            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
                <h2>Error: unknown quiz with pin {{ pin }}</h2>
            </div>
        </div>
    </div>
{% else %}
    <div class="question show">
        <div class="play-header">
            <div class="title">{{ quiz.name }}</div>
            <div class="timer">
                <div class="time-left-txt">Time Left</div>
                <div class="timer-sec">{{ quiz.time_limit }}</div>
            </div>
            <div class="time-line"></div>
        </div>
        <section>
            <div class="question-text"></div>
            <div class="option-list"></div>
        </section>

        <div class="play-footer">
            <div class="total-questions"></div>
            <button class="next-btn">Next</button>
        </div>
    </div>
    <section class="results hide">
        <div class="results-header">
            <h2>Results</h2>
            <div class="score-text"></div>
            <div class="buttons">
                <button class="restart">Retake Quiz</button>
                <button class="home">Take me to the Quizrd Home Page</button>
            </div>  
        </div>      
    </section>

    <script type="module" nonce="{{ g.csp_nonce }}">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { doc, where, query, getFirestore, collection, getDocs, setDoc, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCWY14Mna0pyz15Jcv2jLSq5eVxc2XCHfU",
            authDomain: "quizrd-prod-382117.firebaseapp.com",
            projectId: "quizrd-prod-382117",
            storageBucket: "quizrd-prod-382117.appspot.com",
            messagingSenderId: "338739261213",
            appId: "1:338739261213:web:49d62e4552ffaabcbe7bf4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const unsub = onSnapshot(doc(db, "quizzes", "{{ quiz.id }}"), (doc) => {
            if (doc.data()) {
                let question = parseInt(doc.data().curQuestion)
                if (question == -1) {
                    console.log("Error - Quiz not started yet");
                }
                if ("{{ quiz.sync }}" == "True") {
                    showNextQuestion(question);
                } else {
                    getCurrentQuestion("{{player}}", "{{quiz.id}}")
                    .then((question) => {
                        console.log("CurrentQuestion:", question);
                        showNextQuestion(question);
                    })
                    .catch((err) => console.log("can't get current question:", err));
                }
            } else {
                console.log("Error - Quiz not started yet");
            }
        });

        async function getCurrentQuestion(player, quiz) {
            const results = collection(db, "results");
            const q = query(results, where("player", "==", player), where("quiz", "==", quiz));
            const snap = await getDocs(q);
            let currentQuestion = 0;
            snap.forEach((d) => {
                currentQuestion = d.data().currentQuestion;
            });
            return currentQuestion;
        }

        async function postResults(player, quiz, answers, currentQuestion) {
            const results = collection(db, "results");
            const q = query(results, where("player", "==", player), where("quiz", "==", quiz));
            const snap = await getDocs(q);
            snap.forEach((d) => {
                // doc.data() is never undefined for query doc snapshots
                let data = d.data();
                console.log("results id: ", d.id)
                let docData = { answers: answers, currentQuestion: currentQuestion }
                setDoc(doc(db, "results", d.id), docData,  { merge: true });
            });
        }
        document.postResults = postResults;

        async function resetResults(player, quiz) {
            const results = collection(db, "results");
            const q = query(results, where("player", "==", player), where("quiz", "==", quiz));
            const snap = await getDocs(q);
            let found = false;
            snap.forEach((d) => {
                // A results object already exists for this player/quiz combo, so reset answers.
                found = true;
                let docData = { answers: [], currentQuestion: -1 }
                let data = d.data();
                console.log("results id: ", d.id)
                setDoc(doc(db, "results", d.id), docData,  { merge: true });
            });
            if (!found) {
                // No results object for this player/quiz combo, so create one.
                let docData = { player: player, quiz: quiz, answers: [] }
                const docRef = await addDoc(collection(db, "results"), docData);
            }
        }
        document.postResults = postResults;
        document.resetResults = resetResults;
    </script>

    <script type="text/javascript" nonce="{{ g.csp_nonce }}">
        let link = document.createElement( "link" );
        link.href = "/static/play.css";
        link.type = "text/css";
        link.rel = "stylesheet";
        link.media = "screen,print";
        document.getElementsByTagName("head")[0].appendChild(link);
    </script>
    <script src="/static/play.js" data-quizid="{{ quiz.id }}" data-name="{{ name }}" data-timelimit="{{ quiz.time_limit }}" data-qanda="{{ quiz.qand_a }}" data-sync="{{ quiz.sync }}" type="text/javascript" nonce="{{ g.csp_nonce }}"></script>

{% endif %}
{% endblock %}
