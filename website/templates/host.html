<!--
  Copyright 2021 Google LLC

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

{% extends "base.html" %}

{% block title %}Host Quiz{% endblock %}

{% block content %}

<script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js'></script>

<div>
  <span class="mdc-layout-grid">
    <span class="mdc-layout-grid__inner">
      <span class="mdc-layout-grid__cell mdc-layout-grid__cell--span-1"></span>
      <span class="mdc-layout-grid__cell mdc-layout-grid__cell--span-6">
        <h2>You are hosting quiz "{{ quiz.name }}" (pin {{quiz.pin}}) 
        <h2><span id="current-question">Quiz not running</span></h2>
        <h2 id="players-answered" style="display: none"></h2>
        <h2>URL: <a href="https://quizrd.io/{{pin}}">quizrd.io/{{pin}}</a></h2>
        <a id="start-button" onclick="document.startQuiz()" class="mdc-button mdc-button--raised">
          <span class="mdc-button__ripple"></span>
          <span class="mdc-button__label">Start</span>
        </a>
        <a id="stop-button" onclick="document.stopQuiz()" style="display: none" class="mdc-button mdc-button--raised">
          <span class="mdc-button__ripple"></span>
          <span class="mdc-button__label">Stop</span>
        </a>
        <a id="next-button" style="display: none" onclick="document.incrementQuiz()" class="mdc-button mdc-button--raised">
          <span class="mdc-button__ripple"></span>
          <span class="mdc-button__label">Next</span>
        </a>
        <a id="reveal-button" style="display: none" onclick="document.revealResults()" class="mdc-button mdc-button--raised">
          <span class="mdc-button__ripple"></span>
          <span class="mdc-button__label">Reveal</span>
        </a>
        <br><br><br><br>
        <div id="results-summary" style="margin-left: -200px; height: 1000px; width: 1000px">
          <canvas id="myChart"></canvas>
        </div>
      </span>
      <div id="leaderboard" style="width: 400px; display: none">
        <span class="leaderboard">
          <h1>
            <svg class="ico-cup">
              <use xlink:href="#cup"></use>
            </svg>
            Top Scorers
          </h1>
          <ol>
          </ol>
        </span>
      </div>
    </span>
  </span>

</div>

<svg style="display: none;">
  <symbol id="cup" x="0px" y="0px"
	 width="25px" height="26px" viewBox="0 0 25 26" enable-background="new 0 0 25 26" xml:space="preserve">
<path fill="white" d="M21.215,1.428c-0.744,0-1.438,0.213-2.024,0.579V0.865c0-0.478-0.394-0.865-0.88-0.865H6.69
	C6.204,0,5.81,0.387,5.81,0.865v1.142C5.224,1.641,4.53,1.428,3.785,1.428C1.698,1.428,0,3.097,0,5.148
	C0,7.2,1.698,8.869,3.785,8.869h1.453c0.315,0,0.572,0.252,0.572,0.562c0,0.311-0.257,0.563-0.572,0.563
	c-0.486,0-0.88,0.388-0.88,0.865c0,0.478,0.395,0.865,0.88,0.865c0.421,0,0.816-0.111,1.158-0.303
	c0.318,0.865,0.761,1.647,1.318,2.31c0.686,0.814,1.515,1.425,2.433,1.808c-0.04,0.487-0.154,1.349-0.481,2.191
	c-0.591,1.519-1.564,2.257-2.975,2.257H5.238c-0.486,0-0.88,0.388-0.88,0.865v4.283c0,0.478,0.395,0.865,0.88,0.865h14.525
	c0.485,0,0.88-0.388,0.88-0.865v-4.283c0-0.478-0.395-0.865-0.88-0.865h-1.452c-1.411,0-2.385-0.738-2.975-2.257
	c-0.328-0.843-0.441-1.704-0.482-2.191c0.918-0.383,1.748-0.993,2.434-1.808c0.557-0.663,1-1.445,1.318-2.31
	c0.342,0.192,0.736,0.303,1.157,0.303c0.486,0,0.88-0.387,0.88-0.865c0-0.478-0.394-0.865-0.88-0.865
	c-0.315,0-0.572-0.252-0.572-0.563c0-0.31,0.257-0.562,0.572-0.562h1.452C23.303,8.869,25,7.2,25,5.148
	C25,3.097,23.303,1.428,21.215,1.428z M5.238,7.138H3.785c-1.116,0-2.024-0.893-2.024-1.99c0-1.097,0.908-1.99,2.024-1.99
	c1.117,0,2.025,0.893,2.025,1.99v2.06C5.627,7.163,5.435,7.138,5.238,7.138z M18.883,21.717v2.553H6.118v-2.553H18.883
	L18.883,21.717z M13.673,18.301c0.248,0.65,0.566,1.214,0.947,1.686h-4.24c0.381-0.472,0.699-1.035,0.947-1.686
	c0.33-0.865,0.479-1.723,0.545-2.327c0.207,0.021,0.416,0.033,0.627,0.033c0.211,0,0.42-0.013,0.627-0.033
	C13.195,16.578,13.344,17.436,13.673,18.301z M12.5,14.276c-2.856,0-4.93-2.638-4.93-6.273V1.73h9.859v6.273
	C17.43,11.638,15.357,14.276,12.5,14.276z M21.215,7.138h-1.452c-0.197,0-0.39,0.024-0.572,0.07v-2.06
	c0-1.097,0.908-1.99,2.024-1.99c1.117,0,2.025,0.893,2.025,1.99C23.241,6.246,22.333,7.138,21.215,7.138z"/>
      </symbol>
</svg>

<style>
.leaderboard {
  float: right;
  width: 100%;
  height: 400px;
  background: #F68d2D;
  border-radius: 10px;
  box-shadow: 0 7px 30px rgba(62, 9, 11, .3);

  > h1 {
    font-size: 24px;
    color: white;
    padding: 12px 13px 18px;

    & svg {
      width: 25px;
      height: 26px;
      position: relative;
      top: 3px;
      margin-left: 15px;
      margin-right: 15px;
      vertical-align: baseline;
    }
  }

  > ol {
    counter-reset: leaderboard;

    > li {
      margin-bottom: 10px;
      color: white;
      list-style-type: none;
      position: relative;
      z-index: 1;
      font-size: 20px;
      counter-increment: leaderboard;
      padding: 18px 10px 18px 50px;
      cursor: pointer;
      backface-visibility: hidden;
      transform: translateZ(0) scale(1.0, 1.0);

      &::before {
        content: counter(leaderboard);
        position: absolute;
        z-index: 2;
        top: 15px;
        left: 15px;
        width: 20px;
        height: 20px;
        line-height: 20px;
        color: #F68D2D;
        background: #fff;
        border-radius: 20px;
        text-align: center;
      }

      > mark {
        color: white;
        position: absolute;
        z-index: 2;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        padding: 18px 10px 18px 50px;
        margin: 0;
        background: none;

        &::before, &::after {
          content: '';
          position: absolute;
          z-index: 1;
          bottom: -11px;
          left: -9px;
          border-top: 10px solid #c24448;
          border-left: 10px solid transparent;
          transition: all .1s ease-in-out;
          opacity: 0;
        }

        &::after {
          left: auto;
          right: -9px;
          border-left: none;
          border-right: 10px solid transparent;
        }
      }

      > small {
        position: relative;
        z-index: 2;
        display: block;
        text-align: right;
      }

      &::after {
        content: '';
        position: absolute;
        z-index: 1;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #2C95F6;
        box-shadow: 0 3px 0 rgba(0, 0, 0, .08);
        // transform: scaleX(1.06) scaleY(1.03);
        transition: all .3s ease-in-out;
        opacity: 0;
      }

      &:nth-child(1) {
        background: #2C95F6;
        &::after {
          background: #2C95F6;
        }
      }

      &:nth-child(2) {
        background: #2C95F6;
        &::after {
          background: #2C95F6;
          box-shadow: 0 2px 0 rgba(0, 0, 0, .08);
        }

        & mark {
          &::before, &::after {
            border-top: 6px solid #ba4741;
            bottom: -7px;
          }
        }
      }

      &:nth-child(3) {
        background: #2C95F6;
        &::after {
          background: #2C95F6;
          box-shadow: 0 1px 0 rgba(0, 0, 0, .11);
        }

        & mark {
          &::before, &::after {
            border-top: 2px solid #b0433f;
            bottom: -3px;
          }
        }
      }

      &:nth-child(4) {
        background: #2C95F6;
        &::after {
          background: #2C95F6;
          box-shadow: 0 -1px 0 rgba(0, 0, 0, .15);
        }

        & mark {
          &::before, &::after {
            top: -7px;
            bottom: auto;
            border-top: none;
            border-bottom: 6px solid #a63d3d;;
          }
        }
      }

      &:nth-child(5) {
        background: #2C95F6;
        border-radius: 0 0 10px 10px;
        &::after {
          background: #2C95F6;
          box-shadow: 0 -2.5px 0 rgba(0, 0, 0, .12);
          border-radius: 0 0 10px 10px;
        }

       & mark {
          &::before, &::after {
            top: -9px;
            bottom: auto;
            border-top: none;
            border-bottom: 8px solid #993639;
          }
        }
      }

    }

    // hover
    li:hover {
      z-index: 2;
      overflow: visible;

      &::after {
        opacity: 1;
        transform: scaleX(1.06) scaleY(1.03);
      }

      & mark {
        &::before, &::after {
          opacity: 1;
          transition: all .35s ease-in-out;
        }
      }
    }

  }
}
</style>
  
    <script id="results" type="module" nonce="{{ g.csp_nonce }}" data-questions="{{ quiz.qand_a }}">

    let currentScript = document.getElementById("results");
    let questions = JSON.parse(results.dataset.questions);
    let correct = [];
    for (let i=0; i < questions.length; i++) {
      correct.push(questions[i].correct);
    };
    console.log("correct: ", correct);
    //const data = document.currentScript.dataset;
    //console.log("data: ", data);
    //const questions = data.questions;
    //console.log("questions: ", questions);

    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
    import { doc, where, query, getFirestore, collection, getDoc, getDocs, setDoc, addDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCWY14Mna0pyz15Jcv2jLSq5eVxc2XCHfU",
        authDomain: "quizrd-prod-382117.firebaseapp.com",
        projectId: "quizrd-prod-382117",
        storageBucket: "quizrd-prod-382117.appspot.com",
        messagingSenderId: "338739261213",
        appId: "1:338739261213:web:49d62e4552ffaabcbe7bf4"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function show_quiz_status() {
        console.log("show_quiz_status()");
        let elem = document.getElementById("current-question");
        let players = await getQuizPlayers();
        if (document.currentQuestion < 0) {
            let suffix = "";
            if (players[0] > 1) {
                suffix = "s";
            }
            elem.textContent = "Not started, " + players[0] + " player" + suffix + ": " + players[1];
        } else {
            let suffix = "s";
            if (document.responseCount == 1) {
                suffix = "";
            }
            console.log("respCount:", document.responseCount, "suffix:", suffix)
            let responseCount = document.responseCount || 0;
            let playerCount = document.playerCount || 0;
            elem.textContent = "Question " + (document.currentQuestion + 1) +
                               " of {{ quiz.num_questions }}, " + responseCount +
                               " response" + suffix + " from " + playerCount + " players";
        }
    }

    const unsub = onSnapshot(doc(db, "quizzes", "{{ quiz.id }}"), (doc) => {
        console.log("currentQuestion:", doc.data().curQuestion);
        document.currentQuestion = parseInt(doc.data().curQuestion);
        console.log("doc.curQ:", document.currentQuestion)
        show_quiz_status();
    });

    function enable(id) {
        let elem = document.getElementById(id);
        elem.style.display = "inline-flex";
    }

    function disable(id) {
        let elem = document.getElementById(id);
        elem.style.display = "none";
    }

    async function incrementRunCount() {
        const docRef = doc(db, "quizzes", "{{quiz.id}}");
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) {
            console.log("Error, no such quiz: ", "{{quiz.id}}");
            return;
        }
        let run_count = parseInt(docSnap.data().runCount) + 1
        let docData = {runCount: run_count.toString()};
        await setDoc(doc(db, "quizzes", "{{quiz.id}}"), docData, { merge: true });
    }

    async function getQuizPlayers() {
        console.log("getQuizPlayers()");
        const results = collection(db, "results");
        const q = query(results, where("quiz", "==", "{{ quiz.id }}"));
        const snap = await getDocs(q);
        let players = "";
        let count = 0;
        let limit = 10;
        await snap.forEach((d) => {
            let data = d.data();
            if (count < limit) {
                if (count == 0) {
                    players = data.player;
                } else {
                    players += ",  " + data.player;
                }
            }
            count += 1;
        });
        let ret = [ count, players ];
        console.log("ret: ", ret);
        return ret;
    }

    async function removeResults() {
        const results = collection(db, "results");
        const q = query(results, where("quiz", "==", "{{ quiz.id }}"));
        const snap = await getDocs(q);
        snap.forEach((d) => {
            console.log("doc.ref:", d.ref);
            deleteDoc(d.ref);
        });
    }

    async function startQuiz() {
        let docData = {curQuestion: "0"};
        await setDoc(doc(db, "quizzes", "{{ quiz.id }}"), docData, {merge: true});
        incrementRunCount();
        //removeResults();
        disable("start-button");
        enable("stop-button");
        enable("reveal-button");
        disable("next-button");
        disable("results-summary");
        disable("leaderboard");
        document.playerCount = 0;
        document.responseCount = 0;
        show_quiz_status();
        document.stopPolling()
        document.startPolling(500)
    };

    async function stopQuiz() {
        let docData = {curQuestion: "-1"};
        await setDoc(doc(db, "quizzes", "{{ quiz.id }}"), docData, {merge: true});
        removeResults();
        enable("start-button");
        disable("stop-button");
        disable("reveal-button");
        disable("next-button");
        disable("results-summary");
        enable("leaderboard");
        document.stopPolling()
        document.startPolling(2000);
        show_quiz_status();
    }

    async function incrementQuiz() {
        const docRef = doc(db, "quizzes", "{{ quiz.id }}");
        const snap = await getDoc(docRef);
        console.log("num1:", snap.data().curQuestion)
        let num = parseInt(snap.data().curQuestion) + 1;
        console.log("num2:", num)
        if (num >= {{ quiz.num_questions }}) {
            stopQuiz();
            return;
        }
        document.responseCount = 0;
        let docData = {curQuestion: num.toString()};
        await setDoc(doc(db, "quizzes", "{{ quiz.id }}"), docData, {merge: true});
        enable("reveal-button");
        disable("next-button");
        disable("results-summary");
        disable("leaderboard");
        document.startPolling(500)
    }

    async function revealResults() {
        disable("reveal-button");
        enable("next-button");
        enable("results-summary");
        console.log("survey:", "{{ quiz.survey }}" == "True");
        if ("{{ quiz.survey }}" != "True") {
            enable("leaderboard");
        }
        document.stopPolling()
    }

    function startPolling(interval) {
        document.interval = setInterval(getResults, interval);
    }

    function stopPolling() {
        clearInterval(document.interval);
    }

    document.startQuiz = startQuiz;
    document.stopQuiz = stopQuiz;
    document.incrementQuiz = incrementQuiz;
    document.revealResults = revealResults;
    document.startPolling = startPolling;
    document.stopPolling = stopPolling;

    function resetLeaderboard(leaders) {
        let entries = Object.entries(leaders);
        entries.sort(function(a, b) { return b[1] - a[1]; });
        console.log("entries:", entries);
        let leaderboard = document.querySelector(".leaderboard");
        let list = leaderboard.querySelector("ol");
        while (list.hasChildNodes()) {
          list.removeChild(list.firstChild);
        }
        const limit = 5;
        for (let i=0; i < Math.min(entries.length, limit); i++) {
          let key = entries[i][0];
          let value = entries[i][1];
          console.log(key, value);
          let mark = document.createElement("mark");
          let player = document.createTextNode(key);
          mark.appendChild(player);
          let small = document.createElement("small");
          let score = document.createTextNode(value);
          small.appendChild(score);
          let li = document.createElement("li");
          li.appendChild(mark);
          li.appendChild(small);
          list.appendChild(li);
        };
    };

    async function getResults() {
        const results = collection(db, "results");
        const q = query(results, where("quiz", "==", "{{ quiz.id }}"));
        const snap = await getDocs(q);
        let counters = {};
        let leaders = {};
        let responseCount = 0;
        let playerCount = 0;
        snap.forEach((d) => {
            playerCount++;
            document.playerCount = playerCount;
            let data = d.data();
            let player = data.player;
            let answers = data.answers;
            console.log("player:", player, "answers:", answers);
            let currentPlayerScore = 0;
            for (let i=0; i < answers.length; i++) {
              console.log("i: ", i, "curQ: ", document.currentQuestion);
              if (i == document.currentQuestion) {
                responseCount++;
                document.responseCount = responseCount;
              }
              if (answers[i] == correct[i]) {
                currentPlayerScore++;
              }
            };
            leaders[player] = currentPlayerScore;
            let cur = 0;
            let ans = data.answers[document.currentQuestion];
            if (ans in counters) {
                counters[ans]++;
            } else {
                counters[ans] = 1;
            }
        });
        console.log("leaders: ", leaders);
        console.log("counters: ", counters);
        resetLeaderboard(leaders);
        show_quiz_status();
        graph(Object.keys(counters), Object.values(counters))
    }   

    function graph(labels, data) {
        var ctx = document.getElementById("myChart");
        if (document.currentQuestion < 0) {
            ctx.style.display = "none";
            return;
        }
        ctx.style.display = "block";
        const myChart = document.myChart;
        if (myChart) {
            console.log("labels:", myChart.data.labels);
            console.log("data:", myChart.data.datasets[0].data);
            myChart.data.labels = labels;
            myChart.data.datasets[0].data = data;
            myChart.update();
        } else {
            document.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [labels],
                    datasets: [{
                        label: 'Frequency',
                        data: [data],
                        backgroundColor: [
                            'rgb(255, 99, 132)',
                            'rgb(54, 162, 235)',
                            'rgb(255, 205, 86)',
                            'light green'
                        ],
                        borderColor: [
                            'rgba(255,99,132,1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    //cutoutPercentage: 40,
                    responsive: true,
                    animation: false,
                }
            });
        };
    };
    document.startPolling(2000);
</script>

{% endblock %}
